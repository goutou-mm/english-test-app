<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI è‹±è¯­èƒ½åŠ›æµ‹è¯„</title>
    <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/vant@3/lib/index.css"/>
    <script src="https://fastly.jsdelivr.net/npm/vue@3"></script>
    <script src="https://fastly.jsdelivr.net/npm/vant@3/lib/vant.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        .app-container { 
            max-width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* é¡¶éƒ¨è¿›åº¦æ¡ */
        .progress-header { background: white; padding: 15px 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .progress-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .progress-text { font-size: 14px; color: #666; }
        .progress-text strong { color: #667eea; font-size: 16px; }
        .timer { background: #f0f0f0; padding: 5px 15px; border-radius: 20px; font-size: 14px; color: #333; }
        .progress-bar-container { height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.3s ease; }
        
        /* é¢˜ç›®å¡ç‰‡ */
        .question-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; justify-content: center; }
        .question-card { 
            background: white; border-radius: 20px; padding: 30px; 
            max-width: 600px; width: 100%; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            height: fit-content; margin-top: 10px;
        }
        
        .question-type { display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px 20px; border-radius: 20px; font-size: 14px; margin-bottom: 15px; }
        .question-instruction { background: #f8f9fa; padding: 12px 15px; border-radius: 10px; margin-bottom: 20px; font-size: 13px; color: #666; border-left: 3px solid #667eea; }
        
        /* é€‰é¡¹ */
        .option-item { background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 12px; padding: 15px; margin-bottom: 12px; cursor: pointer; display: flex; align-items: center; }
        .option-item.selected { border-color: #667eea; background: #f0f3ff; }
        .option-label { width: 32px; height: 32px; border-radius: 50%; background: white; border: 2px solid #ccc; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0; }
        .option-item.selected .option-label { background: #667eea; color: white; border-color: #667eea; }

        /* åº•éƒ¨æ“ä½œåŒºä¿®å¤ï¼šåˆå¹¶ç¾è§‚åº¦ä¸é€»è¾‘ */
        .action-footer { 
            padding: 20px; 
            background: white; 
            box-shadow: 0 -5px 15px rgba(0,0,0,0.05);
            display: flex;
            gap: 12px;
        }
        /* è¦†ç›–Vanté»˜è®¤æ ·å¼ï¼Œä½¿ç”¨ä½ å–œæ¬¢çš„é«˜çº§æ„Ÿæ¸å˜è‰² */
        .custom-btn-next { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; border: none !important; }
        .custom-btn-submit { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important; border: none !important; }
        
        /* å¬åŠ›æ’­æ”¾å™¨ */
        .audio-player { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; padding: 20px; margin-bottom: 20px; text-align: center; color: white; }

        /* ========== æ–°å¢ï¼šå¼¹çª—è‡ªå®šä¹‰æ ·å¼ï¼ˆæ ¸å¿ƒä¼˜åŒ–ï¼‰ ========== */
        .result-popup {
            text-align: center;
            padding: 25px 15px 15px !important;
        }
        .result-popup .score-box {
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
        }
        .result-popup .score-num {
            font-size: 56px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
            line-height: 1;
        }
        .result-popup .score-unit {
            font-size: 18px;
            color: #764ba2;
            margin-left: 5px;
            font-weight: 600;
        }
        .result-popup .correct-count {
            font-size: 16px;
            color: #666;
            margin-bottom: 25px;
            line-height: 1.4;
        }
        .result-popup .info-card {
            background: linear-gradient(135deg, #f0f3ff 0%, #f8f0ff 100%);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        .result-popup .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 15px;
            margin-bottom: 8px;
        }
        .result-popup .info-item:last-child {
            margin-bottom: 0;
        }
        .result-popup .info-label {
            color: #888;
            font-weight: 500;
        }
        .result-popup .info-value {
            color: #333;
            font-weight: 600;
        }
        .result-popup .divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, #e0e0e0, transparent);
            margin: 15px 0;
        }
        .result-popup .tips-text {
            font-size: 14px;
            color: #999;
            margin-top: 10px;
        }
    </style>
</head>
<body>
<div id="app" class="app-container">
    <div class="progress-header">
        <div class="progress-info">
            <div class="progress-text">ç¬¬ <strong>{{ currentIndex + 1 }}</strong> / {{ questions.length }} é¢˜</div>
            <div class="timer">â±ï¸ {{ formatTime(totalTime) }}</div>
        </div>
        <div class="progress-bar-container">
            <div class="progress-bar" :style="{ width: progressPercent + '%' }"></div>
        </div>
    </div>
    
    <div class="question-container" v-if="questions.length > 0">
        <div class="question-card">
            <div class="question-type">{{ getTypeLabel(currentQuestion) }}</div>
            <div class="question-instruction">{{ getInstruction(currentQuestion) }}</div>
            
            <div v-if="currentQuestion.audio_text" class="audio-player" @click="toggleAudio(currentQuestion.audio_text, currentIndex)">
                <div class="audio-icon">{{ currentPlayingIndex === currentIndex ? 'â¹ï¸' : 'ğŸ”Š' }}</div>
                <div>{{ currentPlayingIndex === currentIndex ? 'æ­£åœ¨æ’­æ”¾...' : 'ç‚¹å‡»æ’­æ”¾éŸ³é¢‘' }}</div>
            </div>

            <div v-if="currentQuestion.passage" style="background:#f8f9fa; padding:15px; border-radius:10px; margin-bottom:15px; line-height:1.6;">
                {{ currentQuestion.passage }}
            </div>

            <div style="font-size:18px; font-weight:bold; margin-bottom:20px;">{{ currentQuestion.question }}</div>

            <div class="options-container">
                <div v-for="(option, index) in currentQuestion.options" :key="index"
                     class="option-item" :class="{ selected: userAnswers[currentIndex] === option }"
                     @click="selectOption(option)">
                    <div class="option-label">{{ ['A', 'B', 'C', 'D'][index] }}</div>
                    <div class="option-text">{{ option }}</div>
                </div>
            </div>
        </div>
    </div>

    <div class="action-footer" v-if="questions.length > 0">
        <van-button v-if="currentIndex > 0" @click="prevQuestion" round block style="flex:1">ä¸Šä¸€é¢˜</van-button>
        
        <van-button v-if="currentIndex < questions.length - 1" 
                    @click="nextQuestion" 
                    class="custom-btn-next" 
                    type="primary" round block style="flex:2">ä¸‹ä¸€é¢˜</van-button>
        
        <van-button v-if="currentIndex === questions.length - 1" 
                    @click="submitTest" 
                    class="custom-btn-submit" 
                    type="danger" round block style="flex:2">å®Œæˆå¹¶æäº¤</van-button>
    </div>
</div>

<script>
    const app = Vue.createApp({
        data() { 
            return { 
                questions: [], userAnswers: [], currentIndex: 0,
                testStartTime: null, totalTime: 0, timerInterval: null,
                questionMetrics: [], currentPlayingIndex: null,
                hasSubmitted: false, submissionLocked: false
            }; 
        },
        computed: {
            currentQuestion() { return this.questions[this.currentIndex] || {}; },
            progressPercent() { return this.questions.length ? ((this.currentIndex + 1) / this.questions.length) * 100 : 0; }
        },
        created() { this.loadQuestions(); this.checkSubmissionStatus(); },
        mounted() { this.startTimer(); },
        methods: {
            // æ ·å¼ä¸é€»è¾‘è¾…åŠ©æ–¹æ³•
            getTypeLabel(q) { return q.audio_text ? 'ğŸ§ å¬åŠ›ç†è§£' : (q.passage ? 'ğŸ“– é˜…è¯»ç†è§£' : 'ğŸ“ è‹±è¯­æµ‹è¯„'); },
            getInstruction(q) { return q.audio_text ? 'å¬éŸ³é¢‘é€‰æ‹©æ­£ç¡®ç­”æ¡ˆ' : 'è¯·æ ¹æ®é¢˜ç›®é€‰æ‹©æœ€åˆé€‚çš„é€‰é¡¹'; },
            formatTime(s) { return `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`; },
            
            async loadQuestions() {
                const rid = new URLSearchParams(window.location.search).get('rid');
                if(!rid) return vant.Toast.fail("URLç¼ºå°‘ridå‚æ•°");
                try {
                    const res = await fetch(`/api/get-test-data?rid=${rid}`);
                    const result = await res.json();
                    if (result.success) {
                        this.questions = result.data.questions;
                        this.userAnswers = new Array(this.questions.length).fill('');
                        this.initQuestionMetrics();
                        sessionStorage.setItem('studentName', result.data.studentName);
                    }
                } catch (e) { vant.Toast.fail("åŠ è½½å¤±è´¥"); }
            },
            initQuestionMetrics() {
                this.questionMetrics = this.questions.map((q, i) => ({
                    questionIndex: i + 1, startTime: i===0?Date.now():null, timeSpent: 0,
                    isCorrect: false, userAnswer: '', changeCount: 0, audioPlayCount: 0,
                    questionType: q.questionType || 'General', correctAnswer: q.answer
                }));
            },
            startTimer() {
                this.testStartTime = Date.now();
                this.timerInterval = setInterval(() => { this.totalTime = Math.floor((Date.now() - this.testStartTime)/1000); }, 1000);
            },
            selectOption(opt) {
                if(this.submissionLocked) return;
                if(this.userAnswers[this.currentIndex] && this.userAnswers[this.currentIndex] !== opt) {
                    this.questionMetrics[this.currentIndex].changeCount++;
                }
                this.userAnswers[this.currentIndex] = opt;
                this.questionMetrics[this.currentIndex].userAnswer = opt;
            },
            nextQuestion() {
                this.recordTime();
                if(this.currentIndex < this.questions.length - 1) {
                    this.currentIndex++;
                    if(!this.questionMetrics[this.currentIndex].startTime) this.questionMetrics[this.currentIndex].startTime = Date.now();
                }
            },
            prevQuestion() { this.recordTime(); if(this.currentIndex > 0) this.currentIndex--; },
            recordTime() {
                const m = this.questionMetrics[this.currentIndex];
                if(m.startTime) m.timeSpent += (Date.now() - m.startTime)/1000;
                m.startTime = null;
            },
            toggleAudio(text, index) {
                if(this.currentPlayingIndex === index) { window.speechSynthesis.cancel(); this.currentPlayingIndex = null; }
                else {
                    window.speechSynthesis.cancel();
                    const u = new SpeechSynthesisUtterance(text);
                    u.lang = 'en-US';
                    u.onend = () => this.currentPlayingIndex = null;
                    this.questionMetrics[index].audioPlayCount++;
                    this.currentPlayingIndex = index;
                    window.speechSynthesis.speak(u);
                }
            },
            // æäº¤é€»è¾‘
            submitTest() {
                this.recordTime();
                const unanswered = this.userAnswers.filter(a => !a).length;
                if(unanswered > 0) {
                    vant.Dialog.confirm({ title: 'æç¤º', message: `è¿˜æœ‰${unanswered}é¢˜æœªå†™ï¼Œç¡®å®šæäº¤å—ï¼Ÿ` })
                        .then(() => this.executeSubmit());
                } else {
                    this.executeSubmit();
                }
            },
            async executeSubmit() {
                let correct = 0;
                this.questions.forEach((q, i) => {
                    const isCorrect = this.userAnswers[i] === q.answer;
                    if(isCorrect) correct++;
                    this.questionMetrics[i].isCorrect = isCorrect;
                });
                const score = Math.round((correct / this.questions.length) * 100);
                const rid = new URLSearchParams(window.location.search).get('rid');
                
                vant.Toast.loading({ message: 'æäº¤ä¸­...', forbidClick: true });
                
                try {
                    const res = await fetch('/api/submit-test', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            recordId: rid,
                            studentName: sessionStorage.getItem('studentName'),
                            score: score,
                            behaviorData: this.questionMetrics
                        })
                    });
                    const result = await res.json();
                    vant.Toast.clear();
                    if(result.success) {
                        localStorage.setItem(`test_submitted_${rid}`, 'true');
                        // ========== ä¿®æ”¹ï¼šä¼˜åŒ–åçš„å¼¹çª—å†…å®¹ ==========
                        vant.Dialog.alert({
                            title: 'ğŸ‰ æµ‹è¯„å®Œæˆ',
                            allowHtml: true,
                            // å¢åŠ è‡ªå®šä¹‰classï¼Œæ–¹ä¾¿æ ·å¼æ§åˆ¶
                            message: `
                                <div class="result-popup">
                                    <div class="score-box">
                                        <span class="score-num">${score}</span>
                                        <span class="score-unit">åˆ†</span>
                                    </div>
                                    <div class="correct-count">
                                        æœ¬æ¬¡ç­”å¯¹ <strong style="color:#667eea;">${correct}</strong> é¢˜ / å…± <strong style="color:#667eea;">${this.questions.length}</strong> é¢˜
                                    </div>
                                    
                                    <div class="info-card">
                                        <div class="info-item">
                                            <span class="info-label">æ€»ç”¨æ—¶</span>
                                            <span class="info-value">${this.formatTime(this.totalTime)}</span>
                                        </div>
                                        <div class="divider"></div>
                                        <div class="info-item">
                                            <span class="info-label">æ­£ç¡®ç‡</span>
                                            <span class="info-value">${((correct / this.questions.length) * 100).toFixed(1)}%</span>
                                        </div>
                                    </div>
                                    
                                    <div class="tips-text">âœ… æˆç»©å·²è‡ªåŠ¨ä¿å­˜</div>
                                </div>
                            `,
                            // ä¼˜åŒ–å¼¹çª—æŒ‰é’®æ ·å¼
                            confirmButtonText: 'å®Œæˆ',
                            confirmButtonColor: '#667eea'
                        });
                        // ========== å¼¹çª—ä¿®æ”¹ç»“æŸ ==========
                        this.submissionLocked = true;
                    }
                } catch(e) { 
                    vant.Toast.clear();
                    vant.Toast.fail("æäº¤å¤±è´¥"); 
                }
            },
            checkSubmissionStatus() {
                const rid = new URLSearchParams(window.location.search).get('rid');
                if(localStorage.getItem(`test_submitted_${rid}`)) {
                    this.submissionLocked = true;
                    vant.Dialog.alert({ title: 'æé†’', message: 'ä½ å·²ç»æäº¤è¿‡æœ¬æ¬¡æµ‹è¯•äº†ã€‚' });
                }
            }
        }
    }).use(vant).mount('#app');
</script>
</body>
</html>
